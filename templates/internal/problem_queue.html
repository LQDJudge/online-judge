{% extends "two-column-content.html" %}
{% block two_col_media %}{% endblock %}

{% block js_media %}
  <script type="text/javascript">
    $(function () {
      // Function to handle the "Mark private" button click
      $(".mark-private-button").on("click", function () {
        const button = $(this);
        const problemDiv = button.closest(".problem-container");
        const problemId = button.data("problem-id");

        $.ajax({
          url: "{{url('internal_mark_problem_private')}}",
          type: "POST",
          data: {
            id: problemId,
          },
          success: function (response) {
            problemDiv.hide();
          },
          error: function () {
            console.log("An error occurred. Please try again.");
          },
        });
      });

      // Function to handle the "Problem Tag" button click
      $(".problem-tag-button").on("click", function () {
        const button = $(this);
        const problemCode = button.data("problem-code");
        const originalText = button.html();

        // Disable button and show loading
        button.prop('disabled', true);
        button.html('<i class="fa fa-spinner fa-spin"></i> {{_("Analyzing...")}}');

        $.ajax({
          url: "{{url('internal_problem_tag')}}",
          type: "GET",
          data: {
            problem_code: problemCode
          },
          success: function (response) {
            button.prop('disabled', false);
            button.html(originalText);

            if (response.success && response.is_valid) {
              showSuggestionModal(response);
            } else if (response.success && !response.is_valid) {
              alert('{{_("Problem tagging failed: Problem format is incomplete")}}');
            } else {
              alert('{{_("Problem tagging failed: ")}}' + (response.error || 'Unknown error occurred'));
            }
          },
          error: function () {
            button.prop('disabled', false);
            button.html(originalText);

            alert('{{_("Problem tagging failed: Network error occurred - please try again later")}}');
          }
        });
      });

      // Function to show the suggestion modal
      function showSuggestionModal(data) {
        const modal = $('#suggestion-modal');

        $('#apply-suggestions').show();

        $('#modal-title').text('{{_("Suggestion Tag")}} - ' + data.problem_name);

        $('#success-info').show();

        $('#suggested-points').val(data.predicted_points || data.current_points);
        if (data.predicted_points && data.predicted_points !== data.current_points) {
          $('#points-predicted').show().text('{{_("AI Suggested: ")}}' + data.predicted_points);
        } else {
          $('#points-predicted').hide();
        }

        // Initialize Select2 for types
        const typesSelect = $('#suggested-types');
        typesSelect.empty();

        // Add all types as options
        data.all_types.forEach(function(type) {
          const option = new Option(type.name, type.id, false, false);
          typesSelect.append(option);
        });

        const currentTypeIds = data.current_types.map(t => t.id.toString());
        typesSelect.val(currentTypeIds);

        // Add predicted types to selection if they're not already selected
        if (data.predicted_types && data.predicted_types.length > 0) {
          const predictedTypeIds = data.predicted_types.map(t => t.id.toString());
          const combinedSelection = [...new Set([...currentTypeIds, ...predictedTypeIds])];
          typesSelect.val(combinedSelection);

          // Show prediction info
          const predictedNames = data.predicted_types.map(t => t.name).join(', ');
          $('#types-predicted').show().text('{{_("AI Suggested: ")}}' + predictedNames);
        } else {
          $('#types-predicted').hide();
        }

        // Initialize Select2
        typesSelect.select2({
          placeholder: '{{_("Select problem types...")}}',
          allowClear: true,
          width: '100%'
        });

        // Store problem code for form submission
        modal.data('problem-code', data.problem_code);

        // Show modal and prevent body scrolling
        $('body').css('overflow', 'hidden');
        modal.addClass('show');
      }


      // Function to apply suggestions
      $('#apply-suggestions').on('click', function() {
        const modal = $('#suggestion-modal');
        const problemCode = modal.data('problem-code');
        const points = $('#suggested-points').val();
        const types = $('#suggested-types').val() || [];

        const button = $(this);
        const originalText = button.text();

        button.prop('disabled', true).text('{{_("Applying...")}}');

        // Build form data properly for multiple select
        const formData = new FormData();
        formData.append('problem_code', problemCode);
        formData.append('csrfmiddlewaretoken', $('[name=csrfmiddlewaretoken]').val());

        if (points) {
          formData.append('points', points);
        }

        // Append each type ID separately for Django's getlist() to work
        types.forEach(function(typeId) {
          formData.append('types', typeId);
        });

        $.ajax({
          url: "{{url('internal_problem_tag')}}",
          type: "POST",
          data: formData,
          processData: false,
          contentType: false,
          success: function (response) {
            if (response.success) {
              $('body').css('overflow', 'auto');
              modal.removeClass('show');
              location.reload();
            } else {
              alert('{{_("Problem tagging failed: ")}}' + (response.error || 'Unknown error occurred'));
            }
          },
          error: function () {
            alert('{{_("Problem tagging failed: Network error occurred - please try again later")}}');
          },
          complete: function() {
            button.prop('disabled', false).text(originalText);
          }
        });
      });

      // Close modal functionality
      $('.close, #cancel-suggestions').on('click', function() {
        $('body').css('overflow', 'auto');
        $('#suggestion-modal').removeClass('show');
      });

      // Close modal when clicking outside
      $(window).on('click', function(event) {
        const modal = $('#suggestion-modal')[0];
        if (event.target === modal) {
          $('body').css('overflow', 'auto');
          $('#suggestion-modal').removeClass('show');
        }
      });
    });
  </script>
{% endblock %}

{% block left_sidebar %}
  {% include "internal/left-sidebar.html" %}
{% endblock %}

{% block middle_content %}
  {% csrf_token %}
  {% if page_obj.num_pages > 1 %}
    <div style="margin-top:10px;">{% include "list-pages.html" %}</div>
    <br>
  {% endif %}
  {% for problem in problems %}
    <div class="problem-container" style="display: flex; gap: 1em;">
      <div class="blog-box" style="width: 100%">
        <h3 class="problem-feed-name">
          <a href="{{ url('problem_detail', problem.code) }}">
            {{ problem.name }}
          </a>
        </h3>
        {% with authors=problem.get_authors() %}
          {% if authors %}
            <div class="problem-feed-info-entry">
              <i class="far fa-pen-to-square"></i>
              <span class="pi-value">{{ link_users(authors) }}</span>
            </div>
          {% endif %}
        {% endwith %}
        <div class="problem-feed-types">
          <i class="fa fa-tag"></i>
          {% for type in problem.types_list %}
            <span class="type-tag">{{ type }}</span>{% if not loop.last %}, {% endif %}
          {% endfor %}, *{{problem.points | int}}
        </div>
        <div class="blog-description">
          <div class='content-description'>
            {{ problem.description|markdown(lazy_load=True)|reference|str|safe }}
            {% if problem.pdf_description %}
              <embed src="{{url('problem_pdf_description', problem.code)}}" width="100%" height="500" type="application/pdf"
                     style="margin-top: 0.5em">
            {% endif %}
          </div>
          <div class="show-more"> {{_("...More")}} </div>
        </div>
      </div>
      <div style="display: flex; flex-direction: column; gap: 0.5em;">
        <button class="mark-private-button action-btn" data-problem-id="{{ problem.id }}">
          <i class="fa fa-eye-slash"></i> {{_("Mark private")}}
        </button>
        {% if request.user.is_superuser %}
          <button class="problem-tag-button action-btn" data-problem-code="{{ problem.code }}">
            <i class="fa fa-magic"></i> {{_("Problem Tag")}}
          </button>
        {% endif %}
      </div>
    </div>
  {% endfor %}
  {% if page_obj.num_pages > 1 %}
    <div style="margin-top:10px;">{% include "list-pages.html" %}</div>
  {% endif %}

  <!-- Suggestion Modal -->
  <div id="suggestion-modal" class="suggestion-modal">
    <div class="suggestion-modal-content">
      <div class="suggestion-modal-header">
        <h3 id="modal-title">{{_("Suggestion Tag")}}</h3>
        <span class="close">&times;</span>
      </div>

      <!-- Success Content -->
      <div id="success-content">
        <div id="success-info" class="alert alert-info">
          <p><strong>{{_("AI Analysis Results")}}</strong></p>
          <p>{{_("Review and modify the AI suggestions before applying them to the problem.")}}</p>
        </div>

        <form id="suggestion-form">
          <div class="form-group">
            <label for="suggested-points">{{_("Points")}}</label>
            <input type="number" id="suggested-points" min="1" max="1000" step="1">
            <div id="points-predicted" class="predicted-badge" style="display: none;"></div>
          </div>

          <div class="form-group">
            <label for="suggested-types">{{_("Problem Types")}}</label>
            <select id="suggested-types" multiple="multiple">
            </select>
            <div id="types-predicted" class="predicted-badge" style="display: none;"></div>
          </div>
        </form>
      </div>


      <div class="suggestion-actions">
        <button type="button" class="action-btn background-gray" id="cancel-suggestions">{{_("Cancel")}}</button>
        <button type="button" class="action-btn" id="apply-suggestions">{{_("Apply Changes")}}</button>
      </div>
    </div>
  </div>
{% endblock %}