{% extends "base.html" %}

{% block media %}
  {# pagedown_widget.css is already included in style.css via style.scss #}
  {# Styles moved to resources/quiz.scss #}
{% endblock %}

{% block js_media %}
  <script src="{{ static('pagedown/Markdown.Converter.js') }}"></script>
  <script src="{{ static('pagedown-extra/pagedown/Markdown.Converter.js') }}"></script>
  <script src="{{ static('pagedown/Markdown.Sanitizer.js') }}"></script>
  <script src="{{ static('pagedown/Markdown.Editor.js') }}"></script>
  <script src="{{ static('pagedown-extra/Markdown.Extra.js') }}"></script>
  <script>
    function updatePartialCredit(answerId, value) {
      var percentage = parseInt(value);
      document.getElementById('partial_value_' + answerId).textContent = percentage + '%';

      // Update points based on partial credit
      var pointsInput = document.getElementById('points_' + answerId);
      var maxPoints = parseFloat(pointsInput.dataset.max) || 0;
      var newPoints = (maxPoints * percentage / 100).toFixed(1);
      pointsInput.value = newPoints;
    }

    function setPartialCredit(answerId, percentage) {
      var slider = document.getElementById('partial_' + answerId);
      slider.value = percentage;
      updatePartialCredit(answerId, percentage);
    }

    // Sync points input with partial credit slider
    document.addEventListener('DOMContentLoaded', function() {
      document.querySelectorAll('.points-input').forEach(function(input) {
        input.addEventListener('input', function() {
          var answerId = this.id.replace('points_', '');
          var slider = document.getElementById('partial_' + answerId);
          if (slider) {
            var maxPoints = parseFloat(this.dataset.max) || 0;
            var currentPoints = parseFloat(this.value) || 0;
            var percentage = maxPoints > 0 ? Math.round((currentPoints / maxPoints) * 100) : 0;
            slider.value = percentage;
            document.getElementById('partial_value_' + answerId).textContent = percentage + '%';
          }
        });
      });

      // Initialize PageDown editors for feedback textareas
      var converter = Markdown.getSanitizingConverter();
      Markdown.Extra.init(converter, { extensions: 'all' });

      document.querySelectorAll('.feedback-editor-container').forEach(function(container) {
        var textarea = container.querySelector('textarea');
        if (textarea && textarea.id) {
          var suffix = textarea.id.replace('wmd-input', '');
          var editor = new Markdown.Editor(converter, suffix, {});
          editor.run();
        }
      });

      // File preview toggle
      document.querySelectorAll('.file-preview-toggle').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
          e.preventDefault();
          var container = this.closest('.file-item-collapsible');
          var preview = container.querySelector('.file-preview-collapsible');
          var icon = this.querySelector('i');
          var isExpanded = this.getAttribute('aria-expanded') === 'true';

          if (isExpanded) {
            preview.style.display = 'none';
            icon.classList.remove('fa-chevron-up');
            icon.classList.add('fa-chevron-down');
            this.setAttribute('aria-expanded', 'false');
          } else {
            preview.style.display = 'block';
            icon.classList.remove('fa-chevron-down');
            icon.classList.add('fa-chevron-up');
            this.setAttribute('aria-expanded', 'true');
          }
        });
      });
    });
  </script>
{% endblock %}

{% block body %}
  <div class="grading-page">
    <div class="attempt-info">
      <p>
        <strong>{{ _('Quiz') }}:</strong>
        <a href="{{ url('quiz_detail', attempt.quiz.code) }}">{{ attempt.quiz.title }}</a>
      </p>
      <p>
        <strong>{{ _('Student') }}:</strong>
        {{ link_user(attempt.user) }}
      </p>
      <p>
        <strong>{{ _('Attempt') }}:</strong> #{{ attempt.attempt_number }}
      </p>
      <p>
        <strong>{{ _('Submitted') }}:</strong> {{ attempt.end_time|date(_("F j, Y, G:i")) }}
      </p>
      <p>
        <strong>{{ _('Current Score') }}:</strong>
        {{ attempt.score|round(1) if attempt.score else 0 }} / {{ attempt.max_score|round(1) if attempt.max_score else 0 }}
      </p>
    </div>

    <form method="post">
      {% csrf_token %}

      {% for answer in answers %}
        <div class="answer-card">
          <div class="question-header">
            <strong>{{ answer.question.title }}</strong>
            <span class="badge">{{ answer.question.get_question_type_display() }}</span>
            {% if answer.question.question_type in ['MC', 'MA', 'TF'] %}
              <span class="auto-graded-badge">{{ _('Auto-graded') }}</span>
            {% elif answer.question.question_type == 'ES' and not answer.graded_at %}
              <span class="needs-grading-badge">{{ _('Needs Grading') }}</span>
            {% endif %}
          </div>

          <div class="question-content content-description">
            {{ answer.question.content|markdown|reference|str|safe }}
          </div>

          {% if answer.question.question_type in ['MC', 'TF'] and answer.question.choices %}
            <div class="choices-display">
              <strong>{{ _('Choices') }}:</strong>
              {% for choice in answer.question.choices %}
                <div class="grading-choice-item {% if choice.id == answer.answer %}selected-answer{% endif %}">
                  <span class="grading-choice-id">{{ choice.id }}:</span>
                  <span class="grading-choice-text content-description">{{ choice.text|markdown|reference|str|safe }}</span>
                  {% if answer.question.correct_answers and choice.id == answer.question.correct_answers.answers %}
                    <span class="green">({{ _('Correct') }})</span>
                  {% endif %}
                </div>
              {% endfor %}
            </div>
          {% elif answer.question.question_type == 'MA' and answer.question.choices %}
            {% set selected = answer.answer|default('[]') %}
            {% set correct_ids = answer.question.correct_answers.answers|default([]) %}
            <div class="choices-display">
              <strong>{{ _('Choices') }}:</strong>
              {% for choice in answer.question.choices %}
                <div class="grading-choice-item {% if choice.id in selected %}selected-answer{% endif %}">
                  <span class="grading-choice-id">{{ choice.id }}:</span>
                  <span class="grading-choice-text content-description">{{ choice.text|markdown|reference|str|safe }}</span>
                  {% if choice.id in correct_ids %}
                    <span class="green">({{ _('Correct') }})</span>
                  {% endif %}
                </div>
              {% endfor %}
            </div>
          {% endif %}

          <div class="answer-content">
            <strong>{{ _('Student Answer') }}:</strong>
            <div class="student-answer-text content-description">
              {% if answer.question.question_type in ['SA', 'ES'] %}
                {{ answer.answer|markdown|reference|str|safe if answer.answer else _('No answer provided') }}
              {% elif answer.question.question_type == 'MA' %}
                {% if answer.answer %}
                  {% set selected = answer.answer|json_loads if answer.answer is string else answer.answer %}
                  {% if selected and selected|length > 0 %}
                    {{ selected|join(', ') }}
                  {% else %}
                    {{ _('No answer provided') }}
                  {% endif %}
                {% else %}
                  {{ _('No answer provided') }}
                {% endif %}
              {% elif answer.question.question_type in ['MC', 'TF'] %}
                {{ answer.answer or _('No answer provided') }}
              {% else %}
                {{ answer.answer or _('No answer provided') }}
              {% endif %}
            </div>
          </div>

          {% if answer.question.question_type == 'SA' and answer.question.correct_answers %}
            {% set sa_config = answer.question.correct_answers %}
            <div class="correct-answers-display">
              <strong>{{ _('Accepted Answers') }}:</strong>
              <div class="sa-answers-info">
                <span class="sa-match-type">
                  {% if sa_config.type == 'regex' %}
                    <i class="fa fa-code"></i> {{ _('Regex') }}
                  {% else %}
                    <i class="fa fa-equals"></i> {{ _('Exact Match') }}
                  {% endif %}
                  {% if not sa_config.case_sensitive %}
                    ({{ _('case insensitive') }})
                  {% endif %}
                </span>
              </div>
              <ul class="sa-accepted-list">
                {% for ans in sa_config.answers %}
                  <li><span class="sa-answer-text">{{ ans }}</span></li>
                {% endfor %}
              </ul>
            </div>
          {% endif %}

          {% if answer.files.exists() %}
            <div class="file-attachments">
              <strong><i class="fa fa-paperclip"></i> {{ _('Attached Files') }}:</strong>
              {% for file in answer.files.all() %}
                {% set ext = file.get_file_extension() %}
                {% set has_preview = ext in ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'pdf'] %}
                <div class="file-item-collapsible{% if has_preview %} has-preview{% endif %}">
                  <div class="file-item-header">
                    <a href="{{ file.file.url }}" target="_blank">
                      <i class="fa fa-file"></i>
                      {{ file.original_filename }}
                      <span class="text-muted">({{ file.get_file_size() }})</span>
                    </a>
                    {% if has_preview %}
                      <button type="button" class="file-preview-toggle" aria-expanded="false">
                        <i class="fa fa-chevron-down"></i>
                      </button>
                    {% endif %}
                  </div>
                  {% if ext in ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'] %}
                    <div class="file-preview-collapsible file-preview-image" style="display: none;">
                      <img src="{{ file.file.url }}" alt="{{ file.original_filename }}" loading="lazy">
                    </div>
                  {% elif ext == 'pdf' %}
                    <div class="file-preview-collapsible file-preview-pdf" style="display: none;">
                      <iframe src="{{ file.file.url }}" title="{{ file.original_filename }}"></iframe>
                    </div>
                  {% endif %}
                </div>
              {% endfor %}
            </div>
          {% endif %}

          <div class="grade-input">
            <label for="points_{{ answer.id }}">{{ _('Points') }}:</label>
            <input type="number"
                   name="points_{{ answer.id }}"
                   id="points_{{ answer.id }}"
                   class="points-input"
                   data-max="{{ answer.get_max_points() }}"
                   value="{{ answer.points|round(1) if answer.points else 0 }}"
                   min="0"
                   max="{{ answer.get_max_points() }}"
                   step="any">
            <span>/ {{ answer.get_max_points() }}</span>

            {% if answer.graded_at %}
              <span class="text-muted">
                ({{ _('Graded') }}{% if answer.graded_by %} {{ _('by') }} {{ answer.graded_by.user.username }}{% endif %}: {{ answer.graded_at|date(_("F j, Y, G:i")) }})
              </span>
            {% endif %}
          </div>

          {% if answer.question.question_type == 'ES' %}
            <div class="partial-credit-section">
              <label>{{ _('Partial Credit') }}:</label>
              <div class="partial-credit-row">
                <input type="range"
                       name="partial_{{ answer.id }}"
                       id="partial_{{ answer.id }}"
                       class="partial-credit-slider"
                       min="0"
                       max="100"
                       value="{{ (answer.partial_credit * 100)|int if answer.partial_credit else 0 }}"
                       oninput="updatePartialCredit({{ answer.id }}, this.value)">
                <span class="partial-credit-value" id="partial_value_{{ answer.id }}">
                  {{ (answer.partial_credit * 100)|int if answer.partial_credit else 0 }}%
                </span>
                <div class="quick-grade-btns">
                  <button type="button" onclick="setPartialCredit({{ answer.id }}, 0)">0%</button>
                  <button type="button" onclick="setPartialCredit({{ answer.id }}, 50)">50%</button>
                  <button type="button" onclick="setPartialCredit({{ answer.id }}, 75)">75%</button>
                  <button type="button" onclick="setPartialCredit({{ answer.id }}, 100)">100%</button>
                </div>
              </div>
            </div>
          {% endif %}

          <div class="feedback-input">
            <label for="wmd-input-feedback-{{ answer.id }}">{{ _('Feedback') }}:</label>
            <div class="feedback-editor-container">
              <div id="wmd-button-bar-feedback-{{ answer.id }}"></div>
              <textarea name="feedback_{{ answer.id }}"
                        id="wmd-input-feedback-{{ answer.id }}"
                        class="wmd-input"
                        placeholder="{{ _('Optional feedback for the student...') }}">{{ answer.feedback or '' }}</textarea>
            </div>
          </div>
        </div>
      {% endfor %}

      <div class="form-actions">
        <button type="submit" class="action-btn large">
          <i class="fa fa-save"></i> {{ _('Save Grades') }}
        </button>
      </div>
    </form>
  </div>
{% endblock %}
