{% extends "course/base.html" %}
{% from "widgets/sortable_formset.html" import sortable_formset %}

{% block two_col_media %}
  {{ form.media.css }}
  <style type="text/css">
    .field-order, .field-title, .field-points {
      display: inline-flex;
    }
    .form-header {
      margin-bottom: 0.5em;
    }
  </style>
{% endblock %}

{% block js_media %}
  {{ form.media.js }}
  {% if problem_formset %}{{ problem_formset.media.js }}{% endif %}
  {% if quiz_formset %}{{ quiz_formset.media.js }}{% endif %}
  <script src="{{ static('jquery-ui.min.js') }}"></script>
  <script src="{{ static('widgets/sortable_formset.js') }}"></script>
  <script>
    $(function() {
      $('select').each(function() {
        var selectedValues = $(this).val();

        $(this).select2();

        $(this).val(selectedValues);
      });
    });
  </script>
{% endblock %}

{% block middle_content %}
  {% if lesson.id %}
    <center><h2>{{lesson.title}} </h2></center>
  {% endif %}
  <form method="post">
    {% csrf_token %}
    {{ formset.management_form }}
    {% set ns = namespace(problem_formset_has_error=false) %}

    {% if lesson.id %}
      {% set problem_formset = problem_formsets[lesson.id] %}
      {% for form in problem_formset %}
        {% if form.errors %}
          {% set ns.problem_formset_has_error = true %}
          {% break %}
        {% endif %}
      {% endfor %}
    {% endif %}

    <div class="" style=" margin-bottom: 1em">
      {% if lesson.errors %}
        <div class="alert alert-danger alert-dismissable">
          <a href="#" class="close">x</a>
          {{_("Please fix below errors")}}
        </div>
      {% endif %}
      {% for field in lesson_field %}
        {% if field %}
          <div style="margin-bottom: 1em;">
            {{ field.errors }}
            <label for="{{field.id_for_label }}"><b>{{ field.label }}{% if field.field.required %}<span class="red"> * </span>{% endif %}:</b> </label>
            <div class="org-field-wrapper field-{{field.name}}" id="org-field-wrapper-{{field.html_name}}">
              {{ field }}
            </div>
            {% if field.help_text %}
              <small class="org-help-text"><i class="fa fa-exclamation-circle"></i> {{ field.help_text|safe }}</small>
            {% endif %}
          </div>
        {% endif %}
      {% endfor %}

      <!-- Problems Table -->
      {% if problem_formset %}
        <h4>{{_("Problems")}}</h4>
        {{ sortable_formset(problem_formset, {
        'order_field': 'order',
        'add_text': _('Add Problem'),
        'empty_text': _('No problems added yet.')
        }) }}
      {% endif %}

      <!-- Quizzes Table -->
      {% if quiz_formset %}
        <h4 style="display: flex; align-items: center; gap: 0.5em;">
          {{_("Quizzes")}}
          <a href="{{ url('quiz_create') }}" target="_blank" style="font-size: 0.8em; font-weight: normal;">
            <i class="fa fa-plus"></i> {{_("Create Quiz")}}
          </a>
        </h4>
        {{ sortable_formset(quiz_formset, {
        'order_field': 'order',
        'add_text': _('Add Quiz'),
        'empty_text': _('No quizzes added yet.')
        }) }}
      {% endif %}
      <hr/>
    </div>
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <div style="display: flex; gap: 0.5em;">
        <input type="submit" value="{{_('Save')}}" class="action-btn">
        <a href="{{ url('clone_course_lesson', course.slug, lesson.id) }}" class="action-btn" style="text-decoration: none;">
          <i class="fa fa-copy"></i> {{_('Clone')}}
        </a>
      </div>
      {% if current_user_role == 'ADMIN' or current_user_role == 'TE' %}
        <button type="submit" name="delete_lesson" class="btn btn-danger" style="padding: 0.5em 1em; border: none; border-radius: 4px; cursor: pointer; background-color: #d9534f; color: white;" onclick="return confirm('{{_('Are you sure you want to delete this lesson?')}}')">
          <i class="fa fa-trash"></i> {{_('Delete Lesson')}}
        </button>
      {% endif %}
    </div>
  </form>
{% endblock %}
