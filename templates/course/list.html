{% extends "three-column-content.html" %}

{% block three_col_media %}
  <link rel="stylesheet" href="{{ static('course.css') }}">
{% endblock %}

{% block js_media %}
  <script>
    $(function () {
      var $form = $('form#filter-form');
      var $search = $('#search');

      function prep_form() {
        $search.prop('disabled', !$search.val());
      }

      function clean_submit() {
        prep_form();
        $form.submit();
      }

      $search.keypress(function (e) {
        if (e.keyCode == 13)
          $('#go').click();
      });

      $('#go').click(clean_submit);

      $('#role_filter').select2();
    });
  </script>
{% endblock %}

{% block left_sidebar %}
  {% include "course/list_left_sidebar.html" %}
{% endblock %}

{% block right_sidebar %}
  <div id="content-right" class="courses right-sidebar">
    {% include "course/search-form.html" %}
  </div>
{% endblock %}

{% block middle_content %}
  <div class="course-list-page">
    {% if courses %}
      <div class="course-list">
        {% for course in courses %}
          <div class="course-item">
            <div class="course-image">
              {% if course.course_image %}
                <img src="{{ course.course_image.url }}" alt="{{ course.name }}" loading="lazy">
              {% else %}
                {{ course.name|first|upper }}
              {% endif %}
            </div>

            <div class="course-content">
              <div class="course-header">
                <div class="course-title">
                  <a href="{{ url('course_detail', course.slug) }}" class="course-name">
                    {{ course.name }}
                  </a>
                </div>

                <div class="course-badges">
                  {% if current_tab == 'joinable' and request.user.is_authenticated %}
                    <div class="course-join-form">
                      <form method="post" action="{{ url('course_join', course.slug) }}">
                        {% csrf_token %}
                        <button type="submit" class="action-btn background-green">
                          {{ _('Join') }}
                        </button>
                      </form>
                    </div>
                  {% else %}
                    {% if course.is_open %}
                      <span class="badge badge-open">{{ _('Open') }}</span>
                    {% else %}
                      <span class="badge badge-closed">{{ _('Closed') }}</span>
                    {% endif %}
                  {% endif %}
                </div>
              </div>

              {% if course.about %}
                <div class="course-description">
                  {{ course.about|truncatewords(25) }}
                </div>
              {% endif %}

              <div class="course-meta">
                {% set teachers = course.get_teachers() %}
                {% if teachers %}
                  <div class="course-meta-item">
                    <i class="fa fa-user-tie"></i>
                    <span>
                      {{ link_users(teachers[:2]) }}
                      {% if teachers|length > 2 %}
                        {{ _('and %(count)d more', count=teachers|length - 2) }}
                      {% endif %}
                    </span>
                  </div>
                {% endif %}

                {% if course.organizations.exists() %}
                  <div class="course-meta-item">
                    <i class="fa fa-building"></i>
                    <div class="course-organizations">
                      {% for org in course.organizations.all() %}
                        {% include "organization/tag.html" %}
                      {% endfor %}
                    </div>
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
        {% endfor %}
      </div>

      {% if page_obj and page_obj.num_pages > 1 %}
        <div class="pagination-wrapper">
          {% include "list-pages.html" %}
        </div>
      {% endif %}
    {% else %}
      <div class="no-courses">
        {% if current_tab == 'my' %}
          <h3>{{ _('No courses enrolled') }}</h3>
          <p>{{ _('You are not enrolled in any courses yet. Browse available courses and join to start learning!') }}</p>
        {% else %}
          <h3>{{ _('No courses available to join') }}</h3>
          <p>{{ _('There are no open courses available for you to join at this time.') }}</p>
        {% endif %}
      </div>
    {% endif %}
  </div>
{% endblock %}