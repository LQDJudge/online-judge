{% set logged_in = request.user.is_authenticated %}
{% set profile = request.profile if logged_in else None %}
{% for node in mptt_tree(comment_list) recursive %}
<li id="comment-{{ node.id }}" data-revision="{{ node.revisions - 1 }}" data-max-revision="{{ node.revisions - 1 }}"
    data-revision-ajax="{{ url('comment_revision_ajax', node.id) }}" class="comment">
    <div class="comment-display{% if node.score <= vote_hide_threshold %} bad-comment{% endif %}">
        <div class="info">
            <div class="vote">
                {% if logged_in %}
                <a href="javascript:comment_upvote({{ node.id }})"
                    class="upvote-link fa fa-chevron-up fa-fw{% if node.vote_score == 1 %} voted{% endif %}"></a>
                {% else %}
                <a href="javascript:alert('{{ _('Please login to vote')|escapejs }}')"
                    title="{{ _('Please login to vote') }}" class="upvote-link fa fa-chevron-up fa-fw"></a>
                {% endif %}
                <br>
                <div class="comment-score">{{ node.score }}</div>
                {% if logged_in %}
                <a href="javascript:comment_downvote({{ node.id }})"
                    class="downvote-link fa fa-chevron-down fa-fw{% if node.vote_score == -1 %} voted{% endif %}"></a>
                {% else %}
                <a href="javascript:alert('{{ _('Please login to vote')|escapejs }}')"
                    title="{{ _('Please login to vote') }}" class="downvote-link fa fa-chevron-down fa-fw"></a>
                {% endif %}
            </div>
        </div>
        <div class="detail">
            <div class="header">
                {% with author=node.author, user=node.author.user %}
                <a href="{{ url('user_page', user.username) }}" class="user comment-img">
                    <img src="{{ gravatar(author, 135) }}" class="gravatar">
                </a>
                {% endwith %}
                {{ link_user(node.author) }},&nbsp;
                {{ relative_time(node.time, abs=_('{time}'), rel=_('{time}')) }}
                <span class="comment-spacer"></span>
                <span class="comment-operation">
                    {% if node.revisions > 1 %}
                    <span class="comment-edits">
                        <a href="javascript:show_revision({{ node.id }}, -1)" class="previous-revision">&larr;</a>
                        <span class="comment-edit-text">
                            {% if node.revisions > 2 %}
                            {% trans edits=node.revisions - 1 %}edit {{ edits }}{% endtrans %}
                            {% else %}
                            {{ _('edited') }}
                            {% endif %}
                        </span>
                        <a href="javascript:show_revision({{ node.id }}, 1)" style="visibility: hidden"
                            class="next-revision">&rarr;</a>
                    </span>
                    {% else %}
                    <span class="comment-edits"></span>
                    {% endif %}
                    <a href="#comment-{{ node.id }}" title="{{ _('Link') }}" class="comment-link">
                        <i class="fa fa-link fa-fw"></i>
                    </a>
                    {% if logged_in and not comment_lock %}
                    {% set can_edit = node.author.id == profile.id and not profile.mute %}
                    {% if can_edit %}
                    <a data-featherlight="{{ url('comment_edit_ajax', node.id) }}"
                        href="{{ url('comment_edit', node.id) }}" title="{{ _('Edit') }}" class="edit-link">
                        <i class="fa fa-pencil fa-fw"></i>
                    </a>
                    {% else %}
                    <a href="javascript:reply_comment({{ node.id }})" title="{{ _('Reply') }}">
                        <i class="fa fa-reply fa-fw"></i>
                    </a>
                    {% endif %}
                    {% if perms.judge.change_comment %}
                    {% if can_edit %}
                    <a href="javascript:reply_comment({{ node.id }})" title="{{ _('Reply') }}"><i
                            class="fa fa-reply fa-fw"></i></a>
                    {% else %}
                    <a data-featherlight="{{ url('comment_edit_ajax', node.id) }}"
                        href="{{ url('comment_edit', node.id) }}" title="{{ _('Edit') }}" class="edit-link"><i
                            class="fa fa-pencil fa-fw"></i></a>
                    {% endif %}
                    <a href="javascript:" title="{{ _('Hide') }}" data-id="{{ node.id }}" class="hide-comment"><i
                            class="fa fa-trash fa-fw"></i></a>
                    <a href="{{ url('admin:judge_comment_change', node.id) }}" title="{{ _('Admin') }}"><i
                            class="fa fa-cog fa-fw"></i></a>
                    {% endif %}
                    {% endif %}
                </span>
            </div>
            <div class="content content-description">
                <div class="comment-body" {% if node.score <=vote_hide_threshold %} style="display:none" {% endif %}>
                    {{ node.body|markdown(lazy_load=True)|reference|str|safe }}
                </div>
                {% if node.score <= vote_hide_threshold %} <div class="comment-body bad-comment-body">
                    <p>
                        {% trans id=node.id %}This comment is hidden due to too much negative feedback. Click <a
                            href="javascript:comment_show_content({{ id }})">here</a> to view it.{% endtrans %}
                    </p>
            </div>
            {% endif %}
        </div>
    </div>
    </div>

    {% if node.revisions == 1 %}
    {% set real_replies = node.count_replies - node.revisions + 1 %}
    {% else %}
    {% set real_replies = node.count_replies - node.revisions + 2 %}
    {% endif %}
    {% if real_replies > 1 %}
    <a href="javascript:comment_reply({{ node.id }}, {{ object.id }})" class="show_more_reply"> 
        {{ _(' View ') }}  {{ real_replies }} {{ _(' replies ') }} 
    </a>
    {% elif real_replies %}
    <a href="javascript:comment_reply({{ node.id }}, {{ object.id }})" class="show_more_reply"> 
        {{ _(' View ') }} {{ real_replies }} {{_(' reply ') }} 
    </a>
    {% endif %}
</li>
<ul id="comment-{{ node.id }}-reply" class="reply-comment" hidden></ul>
<ul id="comment-{{ node.id }}-children" class="comments"> </ul>
{% endfor %}

{% if replies - offset > 0 %}
<a href="javascript:comment_show_more({{ comment_root_id }}, {{ object.id }}, {{ offset }} )" class="show_more_comment">
    {{ _(' View ') }} {{ replies - offset }} {{ _(' comments more ') }}</a>
{% endif %}